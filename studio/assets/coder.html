<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BloxdForge Coder</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        :root { --background-color: #181818; --surface-color: #282828; --primary-color: #ff8c42; --text-color: #e0e0e0; --border-color: #444; --user-msg-bg: #3a3a3a; --assistant-msg-bg: #2c2c2c; --code-bg: #1e1e1e; }
        body { font-family: 'Segoe UI', sans-serif; display: flex; flex-direction: column; align-items: center; height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; background-color: var(--background-color); color: var(--text-color); }
        #chatWrapper { width: 100%; max-width: 800px; display: flex; flex-direction: column; height: 100%; overflow: hidden; }
        #header { text-align: center; margin-bottom: 15px; flex-shrink: 0; }
        #header img { width: 80px; }
        #header h2 { margin-top: 5px; color: var(--primary-color); }
        #chatContainer { flex-grow: 1; overflow-y: auto; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--surface-color); display: flex; flex-direction: column; gap: 15px; }
        .message { padding: 10px 15px; border-radius: 8px; max-width: 90%; word-wrap: break-word; line-height: 1.6; }
        .user-message { background-color: var(--user-msg-bg); align-self: flex-end; text-align: right; }
        .assistant-message { background-color: var(--assistant-msg-bg); align-self: flex-start; text-align: left; }
        .assistant-message pre { background-color: var(--code-bg); padding: 15px; border-radius: 6px; margin: 10px 0; overflow-x: auto; border: 1px solid #333; }
        .assistant-message code { font-family: Consolas, Monaco, monospace; font-size: 0.9em; }
        .assistant-message p { margin: 0.5em 0; }
        #inputContainer { flex-shrink: 0; display: flex; width: 100%; max-width: 800px; gap: 10px; padding: 15px 0; }
        #userInput { flex-grow: 1; padding: 12px; border: 1px solid var(--primary-color); border-radius: 5px; background-color: var(--surface-color); color: #ffffff; font-size: 1em; }
        button { padding: 12px 25px; border: none; border-radius: 5px; background-color: var(--primary-color); color: #181818; cursor: pointer; font-size: 1em; font-weight: bold; }
        button:disabled { background-color: #666; cursor: not-allowed; }
        button:hover:not(:disabled) { background-color: #e67e3f; }
        .spinner { border: 3px solid #555; border-top: 3px solid var(--primary-color); border-radius: 50%; width: 18px; height: 18px; animation: spin 1s linear infinite; display: inline-block; margin-left: 10px; vertical-align: middle; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .think-box { border: 1px solid #4a4a4a; border-radius: 6px; margin: 12px 0; font-size: 0.9em; background: #222; }
        .think-header { cursor: pointer; padding: 8px 12px; display: flex; align-items: center; user-select: none; border-radius: 6px 6px 0 0; }
        .think-arrow { margin-right: 8px; transition: transform 0.2s; color: var(--primary-color); }
        .think-label { font-weight: bold; color: var(--primary-color); }
        .think-content { padding: 10px 14px; border-top: 1px solid #4a4a4a; color: #c0c0c0; font-family: Consolas, Monaco, monospace; white-space: pre-wrap; word-break: break-word; display: none; }
    </style>
</head>
<body>
    <div id="chatWrapper">
        <div id="header">
            <img id="logo" src="https://imghost.net/ib/Q4w3Wnj3Ctz2MBV_1740586783.png" alt="Logo">
            <h2>BloxdForge Coder</h2>
        </div>
        <div id="chatContainer"></div>
        <div id="inputContainer">
            <input id="userInput" type="text" placeholder="Describe the code you need..." />
            <button id="sendBtn">Send</button>
        </div>
    </div>

    <script>
        let csrfToken = null;
        let userId = null;
        const API_BASE_URL = 'https://khrotu.pythonanywhere.com';
        const RATE_LIMIT_SECONDS = 3;
        let chatHistory = [];
        let isWaitingForResponse = false;
        let messageIdCounter = 0;

        marked.setOptions({
            highlight: (code, lang) => hljs.highlight(code, { language: hljs.getLanguage(lang) ? lang : 'plaintext', ignoreIllegals: true }).value,
            gfm: true,
            breaks: true,
        });

        const getUserId = () => {
            let id = localStorage.getItem('userId');
            if (!id) {
                id = 'user_' + Date.now() + '_' + Math.random().toString(36).substring(2, 11);
                localStorage.setItem('userId', id);
            }
            return id;
        };
        const scrollToBottom = () => document.getElementById('chatContainer').scrollTo({ top: document.getElementById('chatContainer').scrollHeight, behavior: 'smooth' });
        
        const appendMessage = (role, content, isLoading = false) => {
            const chatContainer = document.getElementById('chatContainer');
            const messageId = `msg-${messageIdCounter++}`;
            const messageDiv = document.createElement('div');
            messageDiv.id = messageId;
            messageDiv.className = `message ${role}-message`;
            messageDiv.innerHTML = content + (isLoading ? '<div class="spinner"></div>' : '');
            chatContainer.appendChild(messageDiv);
            scrollToBottom();
            return messageId;
        };

        const updateMessage = (messageId, rawMarkdown) => {
            const messageDiv = document.getElementById(messageId);
            if (!messageDiv) return;

            let reasoningHTML = '';
            let contentMarkdown = rawMarkdown;

            const thinkMatch = rawMarkdown.match(/<think>([\s\S]*?)<\/think>/);
            if (thinkMatch && thinkMatch[1]) {
                const reasoningText = thinkMatch[1].trim();
                contentMarkdown = rawMarkdown.replace(thinkMatch[0], '').trim();
                reasoningHTML = `
                    <div class="think-box">
                        <div class="think-header" onclick="toggleThinkBox(this)">
                            <span class="think-arrow">â–¼</span>
                            <span class="think-label">Thinking Process</span>
                        </div>
                        <div class="think-content">${reasoningText}</div>
                    </div>`;
            }
            messageDiv.innerHTML = reasoningHTML + marked.parse(contentMarkdown);
            scrollToBottom();
        };

        const fetchCsrfToken = async () => {
            try {
                userId = getUserId();
                const response = await fetch(`${API_BASE_URL}/get-csrf-token`, { headers: { 'X-User-ID': userId } });
                if (!response.ok) throw new Error(`Status: ${response.status}`);
                const data = await response.json();
                csrfToken = data.csrf_token;
            } catch (error) {
                appendMessage('assistant', `<strong>Error:</strong> Could not initialize security. Please refresh. (${error.message})`);
                document.getElementById('userInput').disabled = true;
                document.getElementById('sendBtn').disabled = true;
            }
        };

        const askCodeAgent = async () => {
            if (isWaitingForResponse) return;
            const userInputField = document.getElementById("userInput");
            const userInput = userInputField.value.trim();
            if (!userInput || !csrfToken) return;

            isWaitingForResponse = true;
            document.getElementById('sendBtn').disabled = true;
            userInputField.disabled = true;

            chatHistory.push({ role: 'user', content: userInput });
            appendMessage('user', userInput);
            const assistantMsgId = appendMessage('assistant', '', true);
            let accumulatedContent = "";

            try {
                const response = await fetch(`${API_BASE_URL}/api/code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-User-ID': userId, 'X-CSRF-Token': csrfToken },
                    body: JSON.stringify({ messages: chatHistory }),
                });

                if (!response.ok || !response.body) throw new Error(`Network response error: ${response.status}`);

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    let boundary;
                    while ((boundary = buffer.indexOf('\n\n')) >= 0) {
                        const message = buffer.substring(0, boundary);
                        buffer = buffer.substring(boundary + 2);

                        if (message.startsWith('data: ')) {
                            const data = message.substring(6).trim();
                            if (data === '[DONE]') continue;
                            try {
                                const chunk = JSON.parse(data);
                                if (chunk.choices?.[0]?.delta?.content) {
                                    accumulatedContent += chunk.choices[0].delta.content;
                                    updateMessage(assistantMsgId, accumulatedContent);
                                }
                            } catch (e) { console.warn('Could not parse SSE chunk:', data); }
                        }
                    }
                }
                updateMessage(assistantMsgId, accumulatedContent);
                chatHistory.push({ role: 'assistant', content: accumulatedContent });

            } catch (error) {
                console.error('Error in askCodeAgent:', error);
                updateMessage(assistantMsgId, `**Error:** ${error.message}`);
                chatHistory.push({ role: 'assistant', content: `Error: ${error.message}` });
            } finally {
                isWaitingForResponse = false;
                userInputField.disabled = false;
                userInputField.value = '';
                userInputField.focus();
                setTimeout(() => { document.getElementById('sendBtn').disabled = false; }, RATE_LIMIT_SECONDS * 1000);
            }
        };
        
        window.toggleThinkBox = (header) => {
            const content = header.nextElementSibling;
            const arrow = header.querySelector('.think-arrow');
            const isHidden = content.style.display === 'none' || content.style.display === '';
            content.style.display = isHidden ? 'block' : 'none';
            arrow.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
        };

        window.onload = () => {
            appendMessage('assistant', 'Hello! Ask me to help you write JavaScript code using the Bloxd.io API.');
            fetchCsrfToken();
            const userInputField = document.getElementById('userInput');
            const sendBtn = document.getElementById('sendBtn');
            userInputField.focus();
            sendBtn.addEventListener('click', askCodeAgent);
            userInputField.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey && !sendBtn.disabled) {
                    e.preventDefault();
                    askCodeAgent();
                }
            });
        };
    </script>
</body>
</html>